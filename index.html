<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>정반식당 오늘의 메뉴</title>
  <style>
    :root{--bg:#0b0f14;--card:#131922;--muted:#93a2b1;--accent:#4fc3f7;--ok:#8bc34a;--warn:#ffc107;--danger:#ff6b6b}
    html,body{margin:0;padding:0;background:var(--bg);color:#e8eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
    .wrap{max-width:720px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:20px}
    h1{font-size:22px;margin:0 0 4px}
    .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
    button,select,input,textarea{background:#0f141b;color:#e8eef5;border:1px solid #223041;border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#00131c;border:none}
    button.ghost{background:transparent;border:1px dashed #2b3b50;color:#b9c6d3}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .menu-today{border:1px solid #253243;border-radius:12px;padding:16px}
    .menu-today h2{margin:0 0 6px;font-size:18px}
    .menu-today .date{color:var(--muted);font-size:13px}
    .items{margin-top:10px;display:flex;flex-direction:column;gap:6px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0f141b;border:1px solid #253243;border-radius:999px;padding:8px 12px;font-size:13px}
    .week{margin-top:16px;padding-top:12px;border-top:1px dashed #2b3b50}
    .day{margin-top:10px}
    .day h3{margin:0 0 6px;font-size:15px;color:#bfe2ff}
    .empty{color:#97a6b5}
    .admin{margin-top:20px}
    details{border:1px solid #2b3b50;border-radius:12px}
    details[open]{background:#0f141b}
    summary{cursor:pointer;padding:12px 14px;font-weight:600}
    .panel{padding:14px}
    .hint{font-size:12px;color:#aab6c2}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .danger{color:var(--danger)}
    .code{font-family:ui-monospace,Consolas,Menlo,monospace;background:#0b0f14;border:1px solid #223041;border-radius:8px;padding:8px;white-space:pre-wrap}
    .footer{margin-top:16px;color:#7f8b98;font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>정반식당 오늘의 메뉴</h1>
      <div class="sub">클릭 한 번으로 오늘 식단만 확인 · KST 기준 자동 날짜 인식</div>

      <div class="row">
        <button id="btn-today" class="primary">오늘 메뉴 보기</button>
        <button id="btn-week" class="ghost">이번 주 전체 보기</button>
        <select id="campus">
          <option value="main" selected>정반식당</option>
        </select>
        <span class="sub" id="status"></span>
      </div>

      <div class="grid" id="view"></div>

      <div class="admin" id="admin-block">
        <details open>
          <summary>관리자 입력 / OCR (주말에 주간메뉴 등록)</summary>
          <div class="panel">
            <div class="row">
              <input id="pin" type="password" value="2580" placeholder="관리자 PIN (기본 2580)" style="max-width:200px"/>
              <!-- ✅ onclick 직접 박았다 -->
              <button id="btn-auth" onclick="toggleAdmin()">관리자 모드 전환</button>
              <span class="hint">공유용 배포 시 코드에서 PIN을 꼭 바꿔주세요.</span>
            </div>

            <div id="admin-area" style="display:none">
              <div class="row">
                <label>적용 주 시작일(월요일): <input id="weekStart" type="date"></label>
                <button id="btn-clear-week" class="ghost">이번 주 데이터 초기화</button>
              </div>

              <h3>1) 텍스트로 붙여넣기</h3>
              <textarea id="txt" rows="8" placeholder="예시
월) 김치찌개, 제육볶음
화) 된장찌개, 생선구이
수) ...
목) ...
금) ..." style="width:100%"></textarea>
              <div class="row">
                <button id="btn-apply-text" class="primary">주간메뉴 저장</button>
                <span class="hint">형식에 엄격하지 않아도 됩니다. 요일(월~금)만 명확하면 자동 인식합니다.</span>
              </div>

              <h3>2) 이미지 업로드 후 OCR</h3>
              <input id="img" type="file" accept="image/*"/>
              <div class="row">
                <button id="btn-ocr" class="primary">이미지에서 텍스트 추출(OCR)</button>
                <span class="hint">네이버 지도 주간메뉴 이미지를 저장 후 업로드하세요. 정확도가 낮으면 텍스트로 수정하세요.</span>
              </div>
              <div id="ocr-out" class="code" style="display:none"></div>

              <h3>3) 수동 입력(선택)</h3>
              <div id="manual"></div>

              <div class="row" style="margin-top:10px">
                <button id="btn-export" class="ghost">백업 내보내기(JSON)</button>
                <input id="importFile" type="file" accept="application/json"/>
                <button id="btn-import" class="ghost">백업 불러오기</button>
              </div>
            </div>
          </div>
        </details>
      </div>

      <div class="footer">
        데이터는 브라우저 <b>LocalStorage</b>에 저장됩니다. 여러 사람이 공유하려면 추후 Google Sheet/Firebase 연동을 추가로 설정하세요.
      </div>
    </div>
  </div>

<script>
const PIN = '2580';
const KST_OFFSET = 9 * 60;
const storeKey = 'cafeteria.menus.v1';
const weekdays = ['월','화','수','목','금'];
const dataUrl = new URLSearchParams(location.search).get('dataUrl');

const tzNow = () => new Date(new Date().getTime() + (new Date().getTimezoneOffset() + KST_OFFSET) * 60000);
function startOfWeekMonday(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x;}
function fmtDate(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function load(){try{return JSON.parse(localStorage.getItem(storeKey))||{}}catch(e){return {};}}
function save(db){localStorage.setItem(storeKey,JSON.stringify(db));}
function setStatus(msg,cls=''){const el=document.getElementById('status');el.textContent=msg;el.className=cls;}

function renderToday(){
  const view=document.getElementById('view');view.innerHTML='';
  const db=load();const today=tzNow();const key=fmtDate(today);const data=db[key];
  const card=document.createElement('div');card.className='menu-today';
  const weekStr=['일','월','화','수','목','금','토'][today.getDay()];
  card.innerHTML=`<h2>오늘의 메뉴</h2><div class='date'>${key} (${weekStr})</div>`;
  const itemsDiv=document.createElement('div');itemsDiv.className='items';
  if(data?.items?.length){
    data.items.forEach(t=>{const pill=document.createElement('div');pill.className='pill';pill.textContent=t.trim();itemsDiv.appendChild(pill);});
  }else{
    const emp=document.createElement('div');emp.className='empty';emp.textContent='오늘 데이터가 없습니다.';itemsDiv.appendChild(emp);
  }
  card.appendChild(itemsDiv);view.appendChild(card);
}

function renderWeek(){
  const view=document.getElementById('view');view.innerHTML='';
  const db=load();const monday=startOfWeekMonday(tzNow());
  const wrap=document.createElement('div');wrap.className='week';
  for(let i=0;i<5;i++){
    const d=addDays(monday,i);const key=fmtDate(d);
    const day=document.createElement('div');day.className='day';
    const wname=weekdays[i];const head=document.createElement('h3');head.textContent=`${wname} (${key})`;day.appendChild(head);
    const data=db[key];
    if(data?.items?.length){
      const items=document.createElement('div');items.className='items';
      data.items.forEach(t=>{const p=document.createElement('div');p.className='pill';p.textContent=t;items.appendChild(p);});
      day.appendChild(items);
    }else{
      const emp=document.createElement('div');emp.className='empty';emp.textContent='등록된 메뉴 없음';day.appendChild(emp);
    }
    wrap.appendChild(day);
  }
  view.appendChild(wrap);
}

function parseWeeklyText(raw){
  let text=raw.replace(/\r/g,'').replace(/[\t\u00a0]+/g,' ').replace(/ +/g,' ').replace(/\s*\n\s*/g,'\n');
  const blocks={};
  const pattern=/(월|화|수|목|금)[)\]:\s\-]*([^]*?)(?=(?:\n(?:화|수|목|금)\b)|$)/gm;
  let m;while((m=pattern.exec(text))){
    const day=m[1];const body=m[2].replace(/^[)\]:\-\s]+/,'').trim();if(!body) continue;
    const items=body.split(/[,/\n·•\-]\s*/).map(s=>s.trim()).filter(Boolean);blocks[day]=items;
  }
  return blocks;
}

function upsertWeek(blocks, weekMonday, source){
  const db=load();
  for(let i=0;i<5;i++){
    const d=addDays(weekMonday,i);
    const key=fmtDate(d);
    const w=weekdays[i];
    const items=blocks[w]||[];
    if(items.length){
      db[key]={items,meta:{source,updated:new Date().toISOString()}};
    }
  }
  save(db);
}

let adminOn=false;
function toggleAdmin(){
  const pinVal=document.getElementById('pin').value;
  const adminArea=document.getElementById('admin-area');
  if(pinVal===PIN){
    adminOn=true;
    adminArea.style.display='block';
    setStatus('관리자 모드 활성화','ok');
    localStorage.setItem('adminAccess','1');
    const now=tzNow();
    const mon=startOfWeekMonday(now);
    document.getElementById('weekStart').value=fmtDate(mon);
    buildManualForm(mon);
  }else{
    adminOn=false;
    adminArea.style.display='none';
    setStatus('관리자 PIN이 올바르지 않습니다','danger');
    localStorage.removeItem('adminAccess');
  }
}

function buildManualForm(weekMonday){
  const wrap=document.getElementById('manual');wrap.innerHTML='';
  for(let i=0;i<5;i++){
    const d=addDays(weekMonday,i);const key=fmtDate(d);
    const line=document.createElement('div');line.className='row';
    line.innerHTML=`<label style="min-width:80px;display:inline-block">${weekdays[i]}(${key})</label><input data-key="${key}" type="text" placeholder="메뉴들을 , 또는 / 로 구분하여 입력" style="flex:1"/>`;
    wrap.appendChild(line);
  }
}

async function runOCR(){
  if(!adminOn) return setStatus('관리자 모드가 아닙니다','warn');
  const f=document.getElementById('img').files?.[0];
  if(!f) return setStatus('이미지를 선택하세요.','warn');
  setStatus('OCR 처리 중...','warn');
  const worker=await Tesseract.createWorker('kor');
  const {data:{text}}=await worker.recognize(f);
  await worker.terminate();
  document.getElementById('ocr-out').style.display='block';
  document.getElementById('ocr-out').textContent=text.trim();
  const blocks=parseWeeklyText(text);
  const weekStart=document.getElementById('weekStart').value;
  if(weekStart && Object.keys(blocks).length){
    upsertWeek(blocks,new Date(weekStart),'ocr');
    setStatus('OCR 결과 저장 완료','ok');
    renderWeek();
  }else{
    setStatus('OCR 결과에서 요일을 찾지 못했습니다.','danger');
  }
}

document.getElementById('btn-today').addEventListener('click',()=>renderToday());
document.getElementById('btn-week').addEventListener('click',()=>renderWeek());
document.getElementById('btn-apply-text').addEventListener('click',()=>{
  if(!adminOn) return setStatus('관리자 모드가 아닙니다','warn');
  const raw=document.getElementById('txt').value||'';
  const weekStart=document.getElementById('weekStart').value;
  if(!weekStart) return setStatus('적용 주 시작일(월요일)을 선택하세요.','warn');
  const blocks=parseWeeklyText(raw);
  if(Object.keys(blocks).length===0) return setStatus('요일을 찾지 못했습니다. 형식을 확인하세요.','warn');
  upsertWeek(blocks,new Date(weekStart),'text');
  setStatus('주간메뉴 저장 완료','ok');
  renderWeek();
});
document.getElementById('btn-ocr').addEventListener('click',runOCR);
document.getElementById('btn-clear-week').addEventListener('click',()=>{
  if(!adminOn) return setStatus('관리자 모드가 아닙니다','warn');
  const v=document.getElementById('weekStart').value; if(!v) return;
  const db=load(); const mon=new Date(v);
  for(let i=0;i<5;i++){const key=fmtDate(addDays(mon,i)); delete db[key];}
  save(db); setStatus('이번 주 데이터 삭제 완료','ok'); renderWeek();
});
document.getElementById('btn-export').addEventListener('click',()=>{
  const db=load();
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='cafeteria-backup.json';
  a.click();
});
document.getElementById('btn-import').addEventListener('click',()=>{
  const f=document.getElementById('importFile').files?.[0];
  if(!f) return setStatus('가져올 JSON 파일을 선택하세요.','warn');
  const r=new FileReader();
  r.onload=()=>{try{const obj=JSON.parse(r.result); save(obj); setStatus('백업 복원 완료','ok'); renderWeek();}catch(e){setStatus('JSON 파싱 오류','danger');}};
  r.readAsText(f);
});

(async ()=>{
  const qp=new URLSearchParams(location.search);
  const isAdminParam=qp.get('admin')==='1';
  if(dataUrl){
    try{
      const res=await fetch(dataUrl,{cache:'no-store'});
      const text=await res.text();
      const obj=JSON.parse(text);
      save(obj);
      setStatus('공유 데이터 적용됨','ok');
    }catch(e){
      console.error(e);
      setStatus('공유 데이터 불러오기 실패','danger');
    }
  }
  renderToday();

  // admin=1로 들어온 사람은 PIN 누르기 전에 관리자 블록 보이게
  if(isAdminParam){
    // 그냥 바로 보여주기
    document.getElementById('admin-area').style.display='block';
  }
})();
</script>
</body>
</html>
